# wmd详细设计

## 概述

[TOC]

## 修订信息

| 版本  | 时间       | 修订人 | 修订内容         |
|-------|------------|--------|------------------|
| 1.0.0 | 2018-06-20 | 麦志泉 | 创建文档         |
| 1.0.1 | 2018-07-16 | 麦志泉 | 修改资料目录说明 |

---

## 1. wmd介绍

wmd全称Wallet Manager Driver。它是一个能够同时管理多个区块链资产的钱包附加工具。
wmd提供一套规范的区块链资产管理操作命令，使得用户无需关心不同区块链之间的差异，只需要关心如何管理和交换链上的资产。
wmd基于OpenWallet框架进行开发，集成多个区块链协议及其官方节点程序的API交互。
wmd的开发宗旨是，用户只需使用wmd管理过一种区块链资产，就等于熟悉了全部区块链资产的管理。

---

## 2. 需求要点

> 针对每种区块链资产，我们都应该提供以下管理功能。

| 需求             | 描述                                                       | 进度   |
|------------------|------------------------------------------------------------|--------|
| **节点管理相关** |                                                            |        |
| 安装节点         | 自动安装节点程序到服务器，生成钱包配置文件并部署运行。       | 开发中 |
| 启动节点         | 通过配置文件的启动命令，启动节点服务。                       | 开发中 |
| 关闭节点         | 通过配置文件的关闭命令，关闭节点服务。                       | 开发中 |
| 重启节点         | 通过配置文件的启动与关闭命令，重启节点服务。                 | 开发中 |
| 查看节点         | 查看节点版本，安装目录，是否使用docker镜像等信息。            | 开发中 |
| 节点配置         | 查看或初始化某个区块链资产的节点配置。                      | 开发中 |
| **钱包管理相关** |                                                            |        |
| 创建钱包流程     | 能够创建自定义名字的钱包，但可能因官方程序受到一些条件限制。 | 已发布 |
| 查看钱包流程     | 选择钱包，查看钱包余额。                                     | 已发布 |
| 备份钱包流程     | 选择钱包备份，导出文件到备份文件夹中。                       | 已发布 |
| 恢复钱包流程     | 按照提示，输入恢复需要资源。                                 | 已发布 |
| 批量创建地址流程 | 选择钱包，创建批量地址，并导出到txt文件。                     | 已发布 |
| 资产转账         | 选择钱包，转账输入的数量到某个指定地址。                     | 已发布 |
| 定时汇总         | 选择钱包，加入到定时汇总中。                                 | 已发布 |
| 钱包配置         | 查看或初始化某个区块链资产的钱包配置。                      | 开发中 |
| **商户服务相关** |                                                            |        |
| 连接商户接口     | 连接商户系统，提供钱包业务数据，具体业务查看接口文档。        | 开发中 |
| 生成通信密钥对   | 生成通信密钥对，如果已存在，提示用户是否重新生成。            | 开发中 |
| 商户配置         | 查看或重新初始化商户管理配置。                              | 开发中 |

---

## 3. 功能详细设计 `wmd`

我们提供命令行工具wmd，以下功能点作为管理资产的【子命令】，附加以下参数变量。

### 可选参数

| 参数变量    | 描述                                |
|-------------|-------------------------------------|
| -s, -symbol | 币种标识符，其后带值[symbol]，如btc，ltc，eth，ada，btm，sc |
| -i, -init | 是否初始化，应用于配置功能时候，是否需要执行初始化流程。 |
| -p, -path | 文件目录，应用于安装节点时，提供安装的目录。 |

### 文件目录结构

使用wmd管理区块链资产时会创建以下文件目录，存储一些钱包相关的数据。目录用途说明如下：

| 参数变量                 | 描述                                                                         |
|--------------------------|------------------------------------------------------------------------------|
| ./conf/                  | 配置文件目录，文件命名 [symbol].ini                                           |
| ./data/[symbol]/key/     | 钱包根私钥文件目录，文件命名 [alias]-[ID].key                                 |
| ./data/[symbol]/address/ | 钱包批量地址导出目录，文件命名 address-yyyyMMddHHmmss.txt                     |
| ./data/[symbol]/db/      | 钱包外部数据库缓存目录，文件命名 [alias]-[ID].db                              |
| ./data/[symbol]/backup/  | 钱包备份文件导出目录，以文件夹归档备份，文件夹命名 [alias]-[ID]-yyyyMMddHHmmss |
| ./merchant_data/         | 商户配置及相关数据资料                                                       |

> 命令输入结构: wmd [命令模块] [子命令] [可选参数...]
> 如：wmd node install -s btc -p /home/www/btc

### 3.1 节点管理 `node`

| 参数        | 描述                                               |
|-------------|----------------------------------------------------|
| -s, -symbol | 资产类型，其后带值[symbol]，如btc，ltc，eth，ada，btm，sc |

#### 3.1.1 安装节点 `install`

有些已经使用dockerfile做到快速安装节点的，我们集成到wmd中。没有dockerfile，我们等候项目推出才支持。
节点安装流程一般应做到这样。

| 参数        | 描述                                               |
|-------------|----------------------------------------------------|
| -p, -path | 安装路径，其后带值[dir]，文件夹路径，不存在自动创建。|

1. 输入命令: wmd node install -s [symbol] -p [dir]
1. 如果没有自定安装目录，提示输入安装目录。
1. 本地查找./install/[symbol]/下用于执行安装的shell脚本或dockerfile。
1. 把节点程序安装用户自定义的目录下。
1. 修改在./conf/[symbol].ini（如果没有新建），配置节点目录，启动命令，关闭命令，接口API路径等。
1. 启动节点服务。
1. 最后提示用户，节点安装成功，及其相关的信息。

#### 3.1.2 启动节点 `start`

1. 检查配置文件./conf/[symbol].ini是否有启动节点命令，没有提示需要设置。
1. 执行启动命令。用户无需关心是使用docker容器启动还是直接启动。
1. 输出节点信息。

#### 3.1.3 关闭节点 `stop`

1. 检查配置文件./conf/[symbol].ini是否有关闭节点命令，没有提示需要设置。
1. 执行关闭命令。

#### 3.1.4 重启节点 `restart`

1. 检查配置文件./conf/[symbol].ini是否有关闭和启动节点命令，没有提示需要设置。
1. 先执行关闭命令。
1. 检查是否关闭成功，再执行启动节点命令。

#### 3.1.5 节点信息 `info`

1. 检查配置文件./conf/[symbol].ini是否存在，没有提示节点没有安装成功。
1. 输出节点安装目录，启动命令，关闭命令，接口服务路径，节点客户端版本号，节点相关的网络状态。

#### 3.1.6 配置节点信息 `config`

| 参数      | 描述                                  |
|-----------|---------------------------------------|
| -i, -init | 是否重新初始化配置。执行初始化配置流程 |

1. 查看节点的配置信息。
1. 添加-i，执行初始化节点信息流程，与节点相关的配置逐项填写，最后提示二次确认，确认才覆盖保存。

### 3.2 钱包管理 `wallet`

| 参数        | 描述                                               |
|-------------|----------------------------------------------------|
| -s, -symbol | 资产类型，其后带值[symbol]，如btc，ltc，eth，ada，btm，sc |

#### 3.2.1 创建钱包 `new`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 执行钱包创建流程，要求用户输入钱包别名，密码等信息。
1. 大部分钱包都已经支持BIP32，可能钱包同时要创建一个同名的账户。
1. 创建成功后，一般导出一份私钥存储keystore文件到./data/[symbol]/key/目录下。
1. 输出创建成功，及钱包keystore的目录。

#### 3.2.2 查看钱包列表 `list`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 查询节点的钱包列表，并计算出余额。
1. 显示钱包列表到终端。

#### 3.2.3 备份钱包 `backup`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 可能节点提供了备份方法。如果没有，可能通过复制钱包相关的数据文件。
1. 备份文件导出到./data/backup/[钱包别名-钱包id]-yyyyMMddHHmmss/文件夹下。

#### 3.2.4 恢复钱包 `restore`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 提示用户输入恢复钱包的文件路径，待恢复钱包的密码等。
1. 可能节点提供了恢复方法。如果没有，通过覆盖文件到钱包data主目录。
1. 先备份节点原来的钱包数据到一个临时目录。
1. 执行恢复钱包步骤，可能涉及重启钱包，覆盖文件等等操作。
1. 如果恢复成功，检查节点钱包是否使用密码解锁成功。
1. 如果恢复失败，还原钱包。

#### 3.2.5 批量创建地址 `batchaddr`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 提示用户选择钱包，输入创建地址数量，输入解锁钱包密码等。
1. 执行批量创建地址步骤，可能会用外部数据库缓存地址。
1. 批量导出地址到./data/btc/address/address-yyyyMMddHHmmss.txt。

#### 3.2.6 资产转账 `transfer`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 提示用户选择钱包，输入转账数目，转账地址，钱包密码。
1. 如果区块链资产是UTXO账户模型的，可能要自己控制input数量。如果input超过最大限制，需要分拆成多个交易单逐一完成转账。
1. 构建交易单，计算手续费，完成交易签名，广播交易。
1. 完成整个过程后，输出交易单号。

#### 3.2.7 定时汇总 `startsum`

1. 加载配置文件./conf/[symbol].ini的钱包相关变量。
1. 提示用户选择钱包组，输入已选钱包密码，如果没有设置汇总地址，要求输入汇总地址。
1. 验证密码是否通过，可能借助节点接口的解锁钱包方法，或消息签名方法来验证密码。
1. 开启定时器，每间隔X秒运行一次汇总程序。
1. 汇总程序检查钱包余额是否超过汇总阈值，超过执行转账交易，尽量把所有余额转账到汇总地址。
1. 转账成功输出交易单号。

#### 3.2.8 配置钱包信息 `config`

| 参数      | 描述                                  |
|-----------|---------------------------------------|
| -i, -init | 是否重新初始化配置。执行初始化配置流程 |

1. 查看钱包的配置信息。
1. 添加-i，执行初始化钱包信息流程，与钱包相关的配置逐项填写，最后提示二次确认，确认才覆盖保存。

### 3.3 商户配置 `merchant`

| 参数        | 描述                                               |
|-------------|----------------------------------------------------|
| -i, -init   | 是否重新初始化客户端密钥对。                        |

#### 3.3.1 连接商户服务 `keychain`

1. 检查本地是否已创建通信密钥对，没有则创建客户端密钥对，有则显示客户端公钥和服务端公钥。
2. 并提示-i可以重新创建客户端密钥对，如果重新创建，需要商户平台同时跟换客户端公钥。

#### 3.3.2 连接商户服务 `join`

1. 加载配置文件./merchant_data/merchant.ini的商户相关变量。
1. 通过websocket建立连接，成为商户的资产管理数据源节点。
1. 相关的日志记录到日志文件中。

#### 3.3.3 配置商户信息 `merchant`

1. 查看商户的配置信息。
1. 添加-i，执行初始化商户信息流程，与商户相关的配置逐项填写，最后提示二次确认，确认才覆盖保存。

---

## 4. wmd应用说明

### 4.1 编译wmd工具

```shell

# 进入目录
$ $GOPATH/src/github.com/blocktree/OpenWallet/cmd/wmd

# 全部平台版本编译
$ xgo .

# 或自编译某个系统的版本
$ xgo --targets=linux/amd64 .

```

### 4.2 命令示例

#### 节点相关

```shell

# 自动安装[symbol]的官方节点，到[dir]目录。
$ ./wmd node install -s [symbol] -p [dir]

# 执行来自配置文件启动[symbol]节点的命令
$ ./wmd node start -s [symbol]

# 执行来自配置文件关闭[symbol]节点的命令
$ ./wmd node stop -s [symbol]

# 执行来自配置文件关闭[symbol]节点和启动[symbol]节点的命令
$ ./wmd node restart -s [symbol]

# 查看与[symbol]节点相关的信息
$ ./wmd node info -s [symbol]

# 查看./conf/[symbol].ini文件中与节点相关的配置信息
$ ./wmd node config -s [symbol]

# 执行重新初始化节点配置
$ ./wmd node config -s [symbol] -i

```

#### 钱包相关

```shell

# 创建钱包，成功后，文件保存在./data/[symbol]/key/
$ ./wmd wallet new -s [symbol]

# 备份钱包私钥和账户相关文件，文件保存在./data/[symbol]/key/backup/
$ ./wmd wallet backup -s [symbol]

# 执行恢复钱包，提供钱包的备份文件
$ ./wmd wallet restore -s [symbol]

# 执行批量创建地址命令，文件保存在./conf/[symbol]/address/
$ ./wmd wallet batchaddr -s [symbol]

# 启动批量汇总监听器
$ ./wmd wallet startsum -s [symbol]

# 查询钱包列表
$ ./wmd wallet list -s [symbol]

# 发起转行交易
$ ./wmd wallet transfer -s [symbol]

# 查看./conf/[symbol].ini文件中与钱包相关的配置信息
$ ./wmd wallet config -s [symbol]

# 执行重新初始化钱包配置
$ ./wmd wallet config -s [symbol] -i

```

#### 商户相关

```shell

# 查看通信的客户端和服务端公钥，没有自动创建客户端密钥对
$ ./wmd merchant keychain

# 重新创建客户端密钥对
$ ./wmd merchant keychain -i

# 根据配置文件中的相关商户设置信息，连接到商户服务
$ ./wmd merchant join

# 查看./merchant_data/merchant.ini文件中与商户相关的配置信息
$ ./wmd merchant config

# 执行重新初始化商户配置
$ ./wmd merchant config  -i

```